#!/bin/bash
# this is a git tree-filter intented to be run with git filter-branch --tree-filter ./rename-to-openpyxl2
if [ -d openpyxl ]; then
    v2=
    if [ -f openpyxl/.constants.json ] || [ -f openpyxl/_constants.py ]; then
        v2=true
    fi
    grep -h "__major__ = 2" openpyxl/__init__.py >/dev/null && v2=true
    grep -h "__version__ = .2" openpyxl/__init__.py >/dev/null && v2=true
    if [ "$v2" ] ; then
        mv openpyxl openpyxl2
        cp "$0" ./rename-to-openpyxl2
        sed -i "s#openpyxl#openpyxl2#" .hgignore MANIFEST.in pytest.ini setup.py shippable.yml tox.ini 2>/dev/null
        grep -lr "import openpyxl" openpyxl2/ | xargs -n1 sed -i "s#\<openpyxl\>#openpyxl2#g"
        sed -i "s#^Introduction#openpyxl2 is a renamed version of the openpyxl library from version 2 onwards, to allow side-by-side installation with earlier versions.\nNot all documentation etc has been adapted.\nThe entire repository was generated by converting to git and using a git filter-branch command, found in ./rename-to-openpyxl2\n\nIntroduction#" README.rst
        find openpyxl2/ doc/ -name "*.py" | xargs sed -i "s#\(^ *\)from  *openpyxl\([. ]\)#\1from openpyxl2\2#
                s#\(:rtype:.*\|:func:.*\)openpyxl#\1openpyxl2#
                s#\"\"\"openpyxl#\"\"\"openpyxl2#
                s#instances of openpyxl#instances of openpyxl2#"
        find doc/ -name "*.rst" | grep -v changes.rst | xargs sed -i "s#>>> import openpyxl#>>> import openpyxl2#
                s#>>> from openpyxl[.]#>>> from openpyxl2[.]#
                s#module:: openpyxl\$#module:: openpyxl2#
                s#\`openpyxl\`#\`openpyxl2\`#
                s#\`openpyxl[.]#\`openpyxl2[.]#"
    fi
fi

